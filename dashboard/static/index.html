<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Walmart Forecast Dashboard</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #121a2b;
        --muted: #99a7c2;
        --txt: #e6edf9;
        --accent: #35c4a1;
        --accent2: #6aa9ff;
        --warn: #f5b042;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(900px 500px at 10% -10%, #173c58, transparent), var(--bg);
        color: var(--txt);
      }
      .container { max-width: 1300px; margin: 0 auto; padding: 18px; }
      .panel {
        background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border: 1px solid rgba(255,255,255,.1);
        border-radius: 14px;
        padding: 14px;
      }
      .head { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: end; }
      .sub { color: var(--muted); font-size: 14px; }
      .grid { display: grid; gap: 14px; }
      .grid-12 { grid-template-columns: repeat(12, minmax(0, 1fr)); }
      .span-8 { grid-column: span 8; }
      .span-4 { grid-column: span 4; }
      .span-7 { grid-column: span 7; }
      .span-5 { grid-column: span 5; }
      .cards { display: grid; gap: 12px; grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .card { border-radius: 12px; padding: 12px; background: #1b2539; border: 1px solid rgba(255,255,255,.08); }
      .k { color: var(--muted); font-size: 13px; }
      .v { font-size: 24px; font-weight: 700; margin-top: 6px; }
      select, input[type="range"] { width: 100%; }
      select {
        background: #0e1729; color: var(--txt); border: 1px solid rgba(255,255,255,.15);
        border-radius: 10px; padding: 8px;
      }
      .chart { width: 100%; height: 320px; background: #101a2d; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; }
      .bars { display: grid; gap: 10px; }
      .bar { background: #0f1a2e; border: 1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 8px; }
      .bar-track { margin-top: 7px; height: 9px; border-radius: 99px; background: #243146; overflow: hidden; }
      .bar-fill { height: 100%; }
      .legend { font-size: 12px; color: var(--muted); }
      .row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
      @media (max-width: 1100px) {
        .span-8, .span-4, .span-7, .span-5 { grid-column: span 12; }
        .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      }
      @media (max-width: 640px) {
        .head { grid-template-columns: 1fr; }
        .row { grid-template-columns: 1fr; }
        .cards { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="head">
        <div>
          <h1 style="margin:0 0 8px 0;">Walmart Forecast Dashboard</h1>
          <div class="sub">FastAPI backend + ML model + responsive frontend</div>
        </div>
        <div class="panel" style="padding:10px 12px;">Live data + predictions</div>
      </div>

      <div class="grid grid-12" style="margin-top:14px;">
        <div class="panel span-8">
          <div class="row">
            <div>
              <label class="sub">Store</label>
              <select id="store"></select>
            </div>
            <div>
              <label class="sub">Weeks: <span id="weeksVal">160</span></label>
              <input id="weeks" type="range" min="52" max="260" value="160" />
            </div>
          </div>
        </div>
        <div class="panel span-4">
          <label class="sub">Scatter Factor</label>
          <select id="factor">
            <option value="CPI">CPI</option>
            <option value="Unemployment">Unemployment</option>
            <option value="Fuel_Price">Fuel Price</option>
            <option value="Temperature">Temperature</option>
          </select>
          <div id="status" class="sub" style="margin-top:9px;">Loading...</div>
        </div>
      </div>

      <div class="cards" style="margin-top:14px;">
        <div class="card"><div class="k">Average Weekly Sales</div><div id="avg" class="v">-</div></div>
        <div class="card"><div class="k">Peak Sales</div><div id="peak" class="v">-</div></div>
        <div class="card"><div class="k">Holiday Avg</div><div id="havg" class="v">-</div></div>
        <div class="card"><div class="k">Holiday Count</div><div id="hcount" class="v">-</div></div>
      </div>

      <div class="grid grid-12" style="margin-top:14px;">
        <div class="panel span-8">
          <div style="margin-bottom:8px;">Weekly Sales vs Prediction</div>
          <svg id="trend" class="chart" viewBox="0 0 900 320" preserveAspectRatio="none"></svg>
          <div class="legend">Green: Actual, Blue: Predicted</div>
        </div>
        <div class="panel span-4">
          <div style="margin-bottom:8px;">Feature Correlations</div>
          <div id="corrBars" class="bars"></div>
        </div>
      </div>

      <div class="grid grid-12" style="margin-top:14px; margin-bottom:20px;">
        <div class="panel span-7">
          <div style="margin-bottom:8px;">Scatter: Factor vs Sales</div>
          <svg id="scatter" class="chart" viewBox="0 0 900 320" preserveAspectRatio="none"></svg>
          <div class="legend">Orange dots are holiday weeks</div>
        </div>
        <div class="panel span-5">
          <div style="margin-bottom:8px;">Last 12 Rows</div>
          <div style="max-height:320px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:10px;">
            <table style="width:100%; border-collapse: collapse; font-size:12px;">
              <thead>
                <tr style="background:#142036; position:sticky; top:0;">
                  <th style="text-align:left; padding:8px;">Date</th>
                  <th style="text-align:right; padding:8px;">Actual</th>
                  <th style="text-align:right; padding:8px;">Pred</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const state = { stores: [], store: "all", weeks: 160, factor: "CPI", rows: [], corr: [] };

      const fmtMoney = (n) => new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(Number(n || 0));

      const api = (path) => fetch(path).then((r) => {
        if (!r.ok) throw new Error(path + " failed");
        return r.json();
      });

      function buildStoreOptions(stores) {
        const sel = document.getElementById("store");
        sel.innerHTML = `<option value="all">All Stores</option>` + stores.map((s) => `<option value="${s.Store}">Store ${s.Store}</option>`).join("");
      }

      function drawLine(svgId, rows) {
        const svg = document.getElementById(svgId);
        const w = 900;
        const h = 320;
        const pad = 28;
        if (!rows.length) { svg.innerHTML = ""; return; }

        const ys = rows.flatMap((r) => [r.Weekly_Sales, r.Predicted_Sales]);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);
        const yScale = (v) => h - pad - ((v - minY) / Math.max(1, maxY - minY)) * (h - pad * 2);
        const xScale = (_, i) => pad + (i / Math.max(1, rows.length - 1)) * (w - pad * 2);

        const actual = rows.map((r, i) => `${xScale(r, i)},${yScale(r.Weekly_Sales)}`).join(" ");
        const pred = rows.map((r, i) => `${xScale(r, i)},${yScale(r.Predicted_Sales)}`).join(" ");

        svg.innerHTML = `
          <rect x="0" y="0" width="${w}" height="${h}" fill="#101a2d" />
          <polyline fill="none" stroke="#35c4a1" stroke-width="2.2" points="${actual}" />
          <polyline fill="none" stroke="#6aa9ff" stroke-width="2" points="${pred}" />
        `;
      }

      function drawScatter(rows, factor) {
        const svg = document.getElementById("scatter");
        const w = 900;
        const h = 320;
        const pad = 28;
        if (!rows.length) { svg.innerHTML = ""; return; }

        const xs = rows.map((r) => Number(r[factor]));
        const ys = rows.map((r) => Number(r.Weekly_Sales));
        const minX = Math.min(...xs);
        const maxX = Math.max(...xs);
        const minY = Math.min(...ys);
        const maxY = Math.max(...ys);

        const xScale = (v) => pad + ((v - minX) / Math.max(1, maxX - minX)) * (w - pad * 2);
        const yScale = (v) => h - pad - ((v - minY) / Math.max(1, maxY - minY)) * (h - pad * 2);

        svg.innerHTML =
          `<rect x="0" y="0" width="${w}" height="${h}" fill="#101a2d" />` +
          rows
            .map((r) => {
              const color = Number(r.Holiday_Flag) === 1 ? "#f5b042" : "#35c4a1";
              return `<circle cx="${xScale(Number(r[factor]))}" cy="${yScale(Number(r.Weekly_Sales))}" r="3" fill="${color}" />`;
            })
            .join("");
      }

      function renderCorrBars(corr) {
        const el = document.getElementById("corrBars");
        el.innerHTML = corr
          .map((c) => {
            const pct = Math.min(100, Math.abs(c.corr) * 100);
            const color = c.corr >= 0 ? "#35c4a1" : "#f5b042";
            return `
              <div class="bar">
                <div style="display:flex; justify-content:space-between;"><span>${c.feature}</span><span>${Number(c.corr).toFixed(3)}</span></div>
                <div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:${color};"></div></div>
              </div>
            `;
          })
          .join("");
      }

      function renderRows(rows) {
        const tbody = document.getElementById("rows");
        tbody.innerHTML = rows.slice(-12).reverse().map((r) => `
          <tr>
            <td style="padding:8px; border-top:1px solid rgba(255,255,255,.08);">${r.Date}</td>
            <td style="padding:8px; text-align:right; border-top:1px solid rgba(255,255,255,.08);">${fmtMoney(r.Weekly_Sales)}</td>
            <td style="padding:8px; text-align:right; border-top:1px solid rgba(255,255,255,.08);">${fmtMoney(r.Predicted_Sales)}</td>
          </tr>
        `).join("");
      }

      async function refresh() {
        document.getElementById("status").textContent = "Loading...";
        const q = `store=${encodeURIComponent(state.store)}&weeks=${state.weeks}`;
        const [ov, rows, corr] = await Promise.all([
          api(`/api/overview?${q}`),
          api(`/api/store-data?${q}`),
          api(`/api/correlations?${q}`),
        ]);
        state.rows = rows;
        state.corr = corr;

        document.getElementById("avg").textContent = fmtMoney(ov.avg_weekly_sales);
        document.getElementById("peak").textContent = fmtMoney(ov.peak_sales);
        document.getElementById("havg").textContent = fmtMoney(ov.holiday_avg);
        document.getElementById("hcount").textContent = String(ov.holiday_count);
        document.getElementById("status").textContent = `Showing ${ov.records} rows (${ov.date_min} to ${ov.date_max})`;

        drawLine("trend", rows);
        drawScatter(rows, state.factor);
        renderCorrBars(corr);
        renderRows(rows);
      }

      async function init() {
        const stores = await api("/api/stores");
        state.stores = stores;
        buildStoreOptions(stores);

        const storeEl = document.getElementById("store");
        const weeksEl = document.getElementById("weeks");
        const factorEl = document.getElementById("factor");

        storeEl.onchange = async (e) => {
          state.store = e.target.value;
          await refresh();
        };

        weeksEl.oninput = async (e) => {
          state.weeks = Number(e.target.value);
          document.getElementById("weeksVal").textContent = String(state.weeks);
          await refresh();
        };

        factorEl.onchange = (e) => {
          state.factor = e.target.value;
          drawScatter(state.rows, state.factor);
        };

        await refresh();
      }

      init().catch((err) => {
        document.getElementById("status").textContent = "Failed to load dashboard";
        console.error(err);
      });
    </script>
  </body>
</html>
