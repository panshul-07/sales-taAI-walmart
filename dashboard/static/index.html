<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Walmart Sales Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import React, { useEffect, useMemo, useState } from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";
      import {
        ResponsiveContainer,
        LineChart,
        Line,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ScatterChart,
        Scatter,
        BarChart,
        Bar,
        Cell,
      } from "https://esm.sh/recharts@2.12.7";
      import {
        Store,
        TrendingUp,
        Activity,
        Flame,
        DollarSign,
        Gauge,
      } from "https://esm.sh/lucide-react@0.468.0";

      const logoUrl = "https://darussalam.in/wp-content/uploads/2020/09/logo.png";
      const DEFAULT_STORES = Array.from({ length: 45 }, (_, i) => ({ Store: i + 1 }));
      const API_BASE =
        window.location.hostname === "walmart-sales-frontend.onrender.com"
          ? "https://walmart-sales-api.onrender.com"
          : "";
      const apiFetch = (path) => fetch(`${API_BASE}${path}`);

      const factors = [
        { id: "CPI", name: "CPI", color: "#d0ae62", unit: "index" },
        { id: "Unemployment", name: "Unemployment", color: "#25b6aa", unit: "%" },
        { id: "Fuel_Price", name: "Fuel Price", color: "#c39a45", unit: "$" },
        { id: "Temperature", name: "Temperature", color: "#13a89f", unit: "°F" },
      ];

      function fmtCurrency(value) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        }).format(value || 0);
      }

      function fmtNum(value, digits = 2) {
        return Number(value || 0).toFixed(digits);
      }

      function pearsonCorr(x, y) {
        if (!x?.length || x.length !== y.length) return 0;
        const n = x.length;
        const mx = x.reduce((a, b) => a + b, 0) / n;
        const my = y.reduce((a, b) => a + b, 0) / n;
        let num = 0;
        let dx = 0;
        let dy = 0;
        for (let i = 0; i < n; i++) {
          const xv = x[i] - mx;
          const yv = y[i] - my;
          num += xv * yv;
          dx += xv * xv;
          dy += yv * yv;
        }
        const den = Math.sqrt(dx * dy);
        return den === 0 ? 0 : num / den;
      }

      function corrLabel(c) {
        const v = Math.abs(c);
        if (v > 0.7) return "Strong";
        if (v > 0.4) return "Moderate";
        if (v > 0.2) return "Weak";
        return "Very Weak";
      }

      function App() {
        const [stores, setStores] = useState([]);
        const [selectedStore, setSelectedStore] = useState("all");
        const [weeks, setWeeks] = useState(143);
        const [selectedFactor, setSelectedFactor] = useState("CPI");
        const [storeData, setStoreData] = useState([]);
        const [overview, setOverview] = useState(null);
        const [coeffSummary, setCoeffSummary] = useState(null);
        const [storeLoadError, setStoreLoadError] = useState(false);

        useEffect(() => {
          apiFetch("/api/stores")
            .then((r) => {
              if (!r.ok) throw new Error(`Store fetch failed (${r.status})`);
              return r.json();
            })
            .then((rows) => {
              const parsed = Array.isArray(rows) ? rows.filter((s) => Number.isFinite(Number(s.Store))) : [];
              if (!parsed.length) {
                setStores(DEFAULT_STORES);
                setStoreLoadError(true);
                return;
              }
              setStores(parsed.sort((a, b) => Number(a.Store) - Number(b.Store)));
              setStoreLoadError(false);
            })
            .catch(() => {
              setStores(DEFAULT_STORES);
              setStoreLoadError(true);
            });
        }, []);

        useEffect(() => {
          apiFetch(`/api/store-data?store=${selectedStore}&weeks=${weeks}`)
            .then((r) => {
              if (!r.ok) throw new Error(`Store data fetch failed (${r.status})`);
              return r.json();
            })
            .then(setStoreData)
            .catch(() => setStoreData([]));

          apiFetch(`/api/overview?store=${selectedStore}&weeks=${weeks}`)
            .then((r) => {
              if (!r.ok) throw new Error(`Overview fetch failed (${r.status})`);
              return r.json();
            })
            .then(setOverview)
            .catch(() => setOverview(null));

          apiFetch(`/api/coefficients?store=${selectedStore}`)
            .then((r) => {
              if (!r.ok) throw new Error(`Coefficient fetch failed (${r.status})`);
              return r.json();
            })
            .then(setCoeffSummary)
            .catch(() => setCoeffSummary(null));
        }, [selectedStore, weeks]);

        const stats = useMemo(() => {
          if (!storeData.length) {
            return {
              avg: 0,
              peak: 0,
              holidayAvg: 0,
              holidayCount: 0,
            };
          }
          const sales = storeData.map((d) => d.Weekly_Sales);
          const holidays = storeData.filter((d) => d.Holiday_Flag === 1).map((d) => d.Weekly_Sales);
          return {
            avg: sales.reduce((a, b) => a + b, 0) / sales.length,
            peak: Math.max(...sales),
            holidayAvg: holidays.length ? holidays.reduce((a, b) => a + b, 0) / holidays.length : 0,
            holidayCount: holidays.length,
          };
        }, [storeData]);

        const correlations = useMemo(() => {
          if (!storeData.length) return [];
          const y = storeData.map((d) => d.Weekly_Sales);
          return factors.map((f) => {
            const x = storeData.map((d) => d[f.id]);
            const corr = pearsonCorr(x, y);
            return { ...f, corr };
          });
        }, [storeData]);

        const selectedFactorColor = factors.find((f) => f.id === selectedFactor)?.color || "#d0ae62";
        const scatterData = useMemo(
          () =>
            storeData.map((d) => ({
              x: d[selectedFactor],
              y: d.Weekly_Sales,
              holiday: d.Holiday_Flag,
              date: d.Date,
            })),
          [storeData, selectedFactor]
        );

        return (
          React.createElement("div", {
            className: "min-h-screen text-amber-50",
            style: {
              background:
                "radial-gradient(1200px 700px at 92% -8%, rgba(208,174,98,0.24), transparent 58%), radial-gradient(1100px 700px at -8% 108%, rgba(15,143,141,0.33), transparent 62%), linear-gradient(145deg, #041015 0%, #08232a 48%, #05141a 100%)",
            },
          },
            React.createElement("div", {
              className: "fixed inset-0 pointer-events-none opacity-10",
              style: {
                backgroundImage: `url(${logoUrl})`,
                backgroundRepeat: "no-repeat",
                backgroundPosition: "center",
                backgroundSize: "min(58vw, 560px)",
              },
            }),

            React.createElement("div", { className: "relative z-10 max-w-[1600px] mx-auto p-4 md:p-6" },
              React.createElement("div", { className: "flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6" },
                React.createElement("div", null,
                  React.createElement("h1", { className: "text-2xl md:text-4xl font-semibold tracking-tight" }, "Walmart Sales Analytics Dashboard"),
                  React.createElement("p", { className: "text-amber-200/80 mt-2" }, "Interactive analysis for 45 stores with model-aware sales intelligence")
                ),
                React.createElement("div", { className: "px-4 py-2 rounded-full border border-amber-200/30 bg-amber-200/10 text-amber-100 text-sm" }, "Darussalam Hyderabad Theme")
              ),

              React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-12 gap-4" },
                React.createElement("div", { className: "lg:col-span-8 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("div", { className: "flex items-center justify-between mb-3" },
                    React.createElement("h2", { className: "text-lg font-medium flex items-center gap-2" }, React.createElement(Store, { size: 18 }), "Store Selector"),
                    React.createElement("div", { className: "text-sm text-amber-200/80" }, `${stores.length || 45} stores`)
                  ),
                  React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                    React.createElement("div", null,
                      React.createElement("label", { className: "text-sm text-amber-100/80" }, "Choose Store"),
                      React.createElement("select", {
                        value: selectedStore,
                        onChange: (e) => setSelectedStore(e.target.value),
                        className: "w-full mt-1 bg-emerald-900/60 border border-amber-200/30 rounded-lg px-3 py-2",
                      },
                        React.createElement("option", { value: "all" }, "All Stores"),
                        ...stores.map((s) =>
                          React.createElement("option", { key: s.Store, value: String(s.Store) }, `Store ${s.Store}`)
                        )
                      )
                    ),
                    React.createElement("div", { className: "text-sm text-amber-200/85 rounded-lg border border-amber-200/20 bg-emerald-900/35 px-3 py-2" },
                      selectedStore === "all" ? "Showing all 45 stores combined." : `Showing data for Store ${selectedStore}.`,
                      storeLoadError ? " Store list is from local fallback (1-45)." : ""
                    )
                  )
                ),

                React.createElement("div", { className: "lg:col-span-4 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("h2", { className: "text-lg font-medium mb-3" }, "Controls"),
                  React.createElement("label", { className: "text-sm text-amber-100/80" }, "Weeks"),
                  React.createElement("input", {
                    type: "range",
                    min: 52,
                    max: 260,
                    step: 1,
                    value: weeks,
                    onChange: (e) => setWeeks(Number(e.target.value)),
                    className: "w-full mt-1",
                  }),
                  React.createElement("div", { className: "text-sm text-amber-200 mb-3" }, `${weeks} weeks`),

                  React.createElement("label", { className: "text-sm text-amber-100/80" }, "Scatter Factor"),
                  React.createElement("select", {
                    value: selectedFactor,
                    onChange: (e) => setSelectedFactor(e.target.value),
                    className: "w-full mt-1 bg-emerald-900/60 border border-amber-200/30 rounded-lg px-3 py-2",
                  }, ...factors.map((f) => React.createElement("option", { key: f.id, value: f.id }, f.name))),

                  React.createElement("div", { className: "mt-4 text-sm text-amber-100/90" },
                    `Model Accuracy: ${overview?.model?.accuracy_pct?.toFixed?.(2) ?? "-"}%`
                  )
                )
              ),

              React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-4" },
                [
                  { k: "Avg Weekly Sales", v: fmtCurrency(stats.avg), icon: DollarSign, bg: "from-emerald-500/20 to-emerald-300/10" },
                  { k: "Peak Sales", v: fmtCurrency(stats.peak), icon: TrendingUp, bg: "from-amber-500/20 to-amber-300/10" },
                  { k: "Holiday Average", v: fmtCurrency(stats.holidayAvg), icon: Flame, bg: "from-teal-500/20 to-teal-300/10" },
                  { k: "Holiday Count", v: String(stats.holidayCount), icon: Activity, bg: "from-cyan-500/20 to-cyan-300/10" },
                ].map((card) =>
                  React.createElement("div", { key: card.k, className: `rounded-2xl border border-amber-200/30 bg-gradient-to-br ${card.bg} p-4` },
                    React.createElement("div", { className: "flex items-center justify-between mb-2" },
                      React.createElement("div", { className: "text-sm text-amber-100/85" }, card.k),
                      React.createElement(card.icon, { size: 16 })
                    ),
                    React.createElement("div", { className: "text-2xl font-semibold" }, card.v)
                  )
                )
              ),

              React.createElement("div", { className: "grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4" },
                React.createElement("div", { className: "xl:col-span-8 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("h3", { className: "text-lg font-medium mb-3" }, "Weekly Sales Trend"),
                  React.createElement("div", { className: "h-[360px]" },
                    React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                      React.createElement(LineChart, { data: storeData },
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.15)" }),
                        React.createElement(XAxis, { dataKey: "Date", tick: { fill: "#f5ebd4", fontSize: 11 } }),
                        React.createElement(YAxis, { tick: { fill: "#f5ebd4", fontSize: 11 } }),
                        React.createElement(Tooltip, {
                          formatter: (v) => fmtCurrency(v),
                          contentStyle: { background: "#08232a", border: "1px solid rgba(219,191,122,.45)" },
                        }),
                        React.createElement(Line, { type: "monotone", dataKey: "Weekly_Sales", stroke: "#1fc8c3", dot: false, strokeWidth: 2.4, name: "Actual" }),
                        React.createElement(Line, { type: "monotone", dataKey: "Predicted_Sales", stroke: "#d0ae62", dot: false, strokeDasharray: "5 5", strokeWidth: 2, name: "Predicted" })
                      )
                    )
                  )
                ),

                React.createElement("div", { className: "xl:col-span-4 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("h3", { className: "text-lg font-medium mb-3 flex items-center gap-2" }, React.createElement(Gauge, { size: 17 }), "Factor Correlations"),
                  React.createElement("div", { className: "space-y-3" },
                    ...correlations.map((c) => {
                      const pct = Math.min(100, Math.abs(c.corr) * 100);
                      const positive = c.corr >= 0;
                      return React.createElement("div", { key: c.id, className: "rounded-xl border border-amber-200/20 p-3 bg-emerald-900/25" },
                        React.createElement("div", { className: "flex items-center justify-between text-sm" },
                          React.createElement("span", null, c.name),
                          React.createElement("span", { className: "font-semibold" }, `${fmtNum(c.corr, 3)} (${corrLabel(c.corr)})`)
                        ),
                        React.createElement("div", { className: "h-2 rounded-full bg-black/20 mt-2 overflow-hidden" },
                          React.createElement("div", {
                            className: "h-full",
                            style: {
                              width: `${pct}%`,
                              background: positive ? "#17b6a8" : "#d0ae62",
                            },
                          })
                        )
                      );
                    })
                  )
                )
              ),

              React.createElement("div", { className: "grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4" },
                React.createElement("div", { className: "xl:col-span-6 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("h3", { className: "text-lg font-medium mb-3" }, `${selectedFactor} vs Weekly Sales`),
                  React.createElement("div", { className: "h-[340px]" },
                    React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                      React.createElement(ScatterChart, null,
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.15)" }),
                        React.createElement(XAxis, { type: "number", dataKey: "x", name: selectedFactor, tick: { fill: "#f5ebd4", fontSize: 11 } }),
                        React.createElement(YAxis, { type: "number", dataKey: "y", name: "Sales", tick: { fill: "#f5ebd4", fontSize: 11 } }),
                        React.createElement(Tooltip, {
                          cursor: { strokeDasharray: "3 3" },
                          formatter: (v, n) => (n === "y" ? fmtCurrency(v) : fmtNum(v, 2)),
                          contentStyle: { background: "#08232a", border: "1px solid rgba(219,191,122,.45)" },
                        }),
                        React.createElement(Scatter, { data: scatterData, fill: selectedFactorColor },
                          ...scatterData.map((p, i) =>
                            React.createElement(Cell, {
                              key: i,
                              fill: p.holiday ? "#d0ae62" : selectedFactorColor,
                            })
                          )
                        )
                      )
                    )
                  )
                ),

                React.createElement("div", { className: "xl:col-span-6 rounded-2xl border border-amber-200/30 bg-emerald-950/50 p-4" },
                  React.createElement("h3", { className: "text-lg font-medium mb-3" }, "Coefficient Sensitivity (Parametric OLS)"),
                  React.createElement("div", { className: "h-[340px]" },
                    coeffSummary && coeffSummary.rows && coeffSummary.rows.length
                      ? React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                          React.createElement(BarChart, { data: coeffSummary.rows },
                            React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.15)" }),
                            React.createElement(XAxis, { dataKey: "feature", tick: { fill: "#f5ebd4", fontSize: 11 } }),
                            React.createElement(YAxis, { tick: { fill: "#f5ebd4", fontSize: 11 } }),
                            React.createElement(Tooltip, {
                              formatter: (v, name, item) => {
                                if (name === "coef") return [fmtNum(v, 4), "Coefficient"];
                                return [v, name];
                              },
                              labelFormatter: (_, payload) => {
                                const row = payload?.[0]?.payload;
                                if (!row) return "";
                                return `${row.feature} | p=${fmtNum(row.p_value, 5)} | t=${fmtNum(row.t_stat, 3)}`;
                              },
                              contentStyle: { background: "#08232a", border: "1px solid rgba(219,191,122,.45)" },
                            }),
                            React.createElement(Bar, { dataKey: "coef", radius: [8, 8, 0, 0] },
                              ...coeffSummary.rows.map((c) => React.createElement(Cell, { key: c.feature, fill: c.coef >= 0 ? "#17b6a8" : "#d0ae62" }))
                            )
                          )
                        )
                        : React.createElement("div", { className: "h-full flex items-center justify-center text-amber-100/80" }, "Coefficient model unavailable")
                  )
                  ,
                  React.createElement("div", { className: "text-xs text-amber-200/75 mt-2" },
                    coeffSummary
                      ? `Target: ${coeffSummary.target}, Scope: ${coeffSummary.scope}, R²: ${fmtNum(coeffSummary.model_r2, 4)}`
                      : "Sensitivity is based on standardized OLS coefficients for CPI, Unemployment, Fuel Price, and Temperature."
                  )
                )
              )
            )
          )
        );
      }

      createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
