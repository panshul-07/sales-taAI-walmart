<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Walmart Forecast Intelligence Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script type="module">
      import React, { useEffect, useMemo, useState } from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";

      const logoUrl = "https://darussalam.in/wp-content/uploads/2020/09/logo.png";

      const css = `
        :root {
          --bg: #0a1020;
          --panel: rgba(16, 28, 56, 0.72);
          --panel-border: rgba(199, 220, 255, 0.22);
          --accent: #6fd2ff;
          --accent-2: #8dffa3;
          --text: #e8f2ff;
          --muted: #9ab4d4;
        }

        * { box-sizing: border-box; }

        body {
          margin: 0;
          font-family: "Segoe UI", "Avenir Next", system-ui, sans-serif;
          color: var(--text);
          background:
            radial-gradient(1200px 700px at 80% -10%, rgba(63, 135, 255, 0.25), transparent 60%),
            radial-gradient(1000px 600px at -10% 110%, rgba(13, 191, 142, 0.25), transparent 55%),
            linear-gradient(145deg, #071022 0%, #09172f 50%, #071022 100%);
          min-height: 100vh;
        }

        body::before {
          content: "";
          position: fixed;
          inset: 0;
          background-image: url('${logoUrl}');
          background-repeat: no-repeat;
          background-position: center;
          background-size: min(58vw, 560px);
          opacity: 0.07;
          filter: grayscale(0.05) contrast(1.1);
          pointer-events: none;
          z-index: 0;
        }

        .app {
          position: relative;
          z-index: 1;
          padding: 22px;
          max-width: 1500px;
          margin: 0 auto;
        }

        .title-wrap {
          display: flex;
          justify-content: space-between;
          align-items: end;
          gap: 12px;
          margin-bottom: 20px;
        }

        .title h1 {
          margin: 0;
          font-size: clamp(1.5rem, 2.7vw, 2.5rem);
          letter-spacing: 0.3px;
        }

        .title p { margin: 6px 0 0; color: var(--muted); }

        .chip {
          padding: 8px 12px;
          border-radius: 999px;
          border: 1px solid var(--panel-border);
          background: rgba(111, 210, 255, 0.12);
          font-size: 0.9rem;
          color: #d7f3ff;
        }

        .controls, .cards, .grid {
          display: grid;
          gap: 14px;
        }

        .controls {
          grid-template-columns: repeat(4, minmax(0, 1fr));
          margin-bottom: 14px;
        }

        .cards {
          grid-template-columns: repeat(5, minmax(0, 1fr));
          margin-bottom: 14px;
        }

        .grid {
          grid-template-columns: repeat(12, minmax(0, 1fr));
        }

        .panel {
          background: var(--panel);
          border: 1px solid var(--panel-border);
          border-radius: 16px;
          backdrop-filter: blur(8px);
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.32);
        }

        .control {
          padding: 12px;
        }

        .control label {
          font-size: 0.82rem;
          color: var(--muted);
          display: block;
          margin-bottom: 6px;
          letter-spacing: 0.3px;
        }

        .control select, .control input {
          width: 100%;
          border: 1px solid rgba(186, 214, 255, 0.35);
          background: rgba(8, 20, 42, 0.9);
          color: var(--text);
          border-radius: 10px;
          padding: 9px;
          outline: none;
        }

        .card {
          padding: 14px;
        }

        .card .k {
          font-size: 0.82rem;
          color: var(--muted);
          margin-bottom: 7px;
        }

        .card .v {
          font-weight: 700;
          font-size: clamp(1.05rem, 1.6vw, 1.45rem);
          color: #f4fbff;
        }

        .plot-panel {
          padding: 8px;
        }

        .span-12 { grid-column: span 12; }
        .span-8 { grid-column: span 8; }
        .span-6 { grid-column: span 6; }
        .span-4 { grid-column: span 4; }

        .plot {
          width: 100%;
          min-height: 380px;
        }

        .plot.small { min-height: 330px; }

        @media (max-width: 1200px) {
          .cards { grid-template-columns: repeat(3, minmax(0, 1fr)); }
          .controls { grid-template-columns: repeat(2, minmax(0, 1fr)); }
          .span-8, .span-6, .span-4 { grid-column: span 12; }
        }

        @media (max-width: 720px) {
          .cards, .controls { grid-template-columns: 1fr; }
          .app { padding: 14px; }
        }
      `;

      function fmt(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return "-";
        return new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 }).format(value);
      }

      function useApi(path) {
        const [data, setData] = useState(null);
        const [error, setError] = useState(null);

        useEffect(() => {
          let active = true;
          fetch(path)
            .then((r) => r.json())
            .then((d) => active && setData(d))
            .catch((e) => active && setError(e.message));
          return () => {
            active = false;
          };
        }, [path]);

        return { data, error };
      }

      function Plot({ id, data, layout, config, className = "plot" }) {
        useEffect(() => {
          if (!data) return;
          Plotly.newPlot(id, data, layout, config);
          return () => Plotly.purge(id);
        }, [id, data, layout, config]);

        return React.createElement("div", { id, className });
      }

      function App() {
        const [store, setStore] = useState("all");
        const [weeks, setWeeks] = useState(160);
        const [feature, setFeature] = useState("CPI");

        const storesApi = useApi("/api/stores");
        const overviewApi = useApi(`/api/overview?store=${store}&weeks=${weeks}`);
        const tsApi = useApi(`/api/timeseries?store=${store}&weeks=${weeks}`);
        const depApi = useApi(`/api/feature-dependencies?store=${store}&weeks=${weeks}`);
        const featSeriesApi = useApi(`/api/feature-series?store=${store}&weeks=${weeks}&feature=${feature}`);
        const corrApi = useApi(`/api/correlation?store=${store}&weeks=${weeks}`);

        const storeOptions = useMemo(() => {
          const rows = storesApi.data || [];
          return [{ Store: "all" }, ...rows];
        }, [storesApi.data]);

        const overview = overviewApi.data || {};
        const model = overview.model || {};
        const ts = tsApi.data || { date: [], actual: [], predicted: [] };
        const deps = depApi.data || {};
        const fs = featSeriesApi.data || { date: [], feature_values: [], sales: [] };
        const corr = corrApi.data || { labels: [], z: [] };

        const cardData = [
          ["Total Sales", `$${fmt(overview.total_sales)}`],
          ["Avg Weekly Sales", `$${fmt(overview.avg_weekly_sales)}`],
          ["Model Accuracy", `${fmt(model.accuracy_pct)}%`],
          ["MAPE", `${fmt(model.mape_pct)}%`],
          ["RÂ²", fmt(model.r2)],
        ];

        const plotTheme = {
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)",
          font: { color: "#deebff", family: "Segoe UI, sans-serif" },
          margin: { l: 55, r: 25, t: 55, b: 45 },
        };

        const tsData = [
          {
            x: ts.date,
            y: ts.actual,
            type: "scatter",
            mode: "lines",
            name: "Actual Sales",
            line: { width: 2.5, color: "#80e5ff" },
          },
          {
            x: ts.date,
            y: ts.predicted,
            type: "scatter",
            mode: "lines",
            name: "Predicted Sales",
            line: { width: 2, color: "#9cffb1", dash: "dot" },
          },
        ];

        const depColors = {
          CPI: "#7bdff6",
          Unemployment: "#f7d6e0",
          Fuel_Price: "#f2b5d4",
          Temperature: "#b2f7ef",
        };

        const depData = Object.entries(deps).map(([k, val]) => ({
          x: val.x,
          y: val.y,
          mode: "markers",
          type: "scatter",
          name: k,
          marker: { color: depColors[k], size: 6, opacity: 0.65 },
        }));

        const fsData = [
          {
            x: fs.date,
            y: fs.sales,
            type: "scatter",
            mode: "lines",
            name: "Sales",
            line: { color: "#90e0ef", width: 2.2 },
            yaxis: "y",
          },
          {
            x: fs.date,
            y: fs.feature_values,
            type: "scatter",
            mode: "lines",
            name: feature,
            line: { color: "#f9c74f", width: 2 },
            yaxis: "y2",
          },
        ];

        return React.createElement(
          "div",
          { className: "app" },
          React.createElement("style", null, css),
          React.createElement(
            "div",
            { className: "title-wrap" },
            React.createElement(
              "div",
              { className: "title" },
              React.createElement("h1", null, "Walmart 45-Store Forecast Command Center"),
              React.createElement(
                "p",
                null,
                "Interactive demand intelligence with live model overlays, feature dependence, and macro-sensitive diagnostics."
              )
            ),
            React.createElement("div", { className: "chip" }, "Darussalam Hyderabad Theme")
          ),

          React.createElement(
            "div",
            { className: "controls" },
            React.createElement(
              "div",
              { className: "panel control" },
              React.createElement("label", null, "Store"),
              React.createElement(
                "select",
                { value: store, onChange: (e) => setStore(e.target.value) },
                storeOptions.map((s, i) =>
                  React.createElement(
                    "option",
                    { key: i, value: String(s.Store) },
                    s.Store === "all" ? "All 45 Stores" : `Store ${s.Store}`
                  )
                )
              )
            ),
            React.createElement(
              "div",
              { className: "panel control" },
              React.createElement("label", null, "Weeks to display"),
              React.createElement("input", {
                type: "range",
                min: 52,
                max: 260,
                step: 4,
                value: weeks,
                onChange: (e) => setWeeks(Number(e.target.value)),
              }),
              React.createElement("div", { style: { color: "#9ab4d4", marginTop: "6px", fontSize: "0.9rem" } }, `${weeks} weeks`)
            ),
            React.createElement(
              "div",
              { className: "panel control" },
              React.createElement("label", null, "Feature-linked trend"),
              React.createElement(
                "select",
                { value: feature, onChange: (e) => setFeature(e.target.value) },
                ["CPI", "Unemployment", "Fuel_Price", "Temperature"].map((f) =>
                  React.createElement("option", { key: f, value: f }, f)
                )
              )
            ),
            React.createElement(
              "div",
              { className: "panel control" },
              React.createElement("label", null, "Model status"),
              React.createElement(
                "div",
                { style: { paddingTop: "10px", color: "#caf5d8", fontWeight: 600 } },
                `ExtraTrees live | MAPE ${fmt(model.mape_pct)}%`
              )
            )
          ),

          React.createElement(
            "div",
            { className: "cards" },
            ...cardData.map(([k, v]) =>
              React.createElement(
                "div",
                { className: "panel card", key: k },
                React.createElement("div", { className: "k" }, k),
                React.createElement("div", { className: "v" }, v)
              )
            )
          ),

          React.createElement(
            "div",
            { className: "grid" },

            React.createElement(
              "div",
              { className: "panel plot-panel span-8" },
              React.createElement(Plot, {
                id: "ts-plot",
                className: "plot",
                data: tsData,
                layout: {
                  ...plotTheme,
                  title: "Actual vs Predicted Weekly Sales",
                  xaxis: { title: "Date" },
                  yaxis: { title: "Sales" },
                  legend: { orientation: "h" },
                },
                config: { responsive: true, displaylogo: false },
              })
            ),

            React.createElement(
              "div",
              { className: "panel plot-panel span-4" },
              React.createElement(Plot, {
                id: "corr-plot",
                className: "plot small",
                data: [
                  {
                    z: corr.z,
                    x: corr.labels,
                    y: corr.labels,
                    type: "heatmap",
                    colorscale: "RdBu",
                    zmid: 0,
                  },
                ],
                layout: {
                  ...plotTheme,
                  title: "Feature Correlation Matrix",
                },
                config: { responsive: true, displaylogo: false },
              })
            ),

            React.createElement(
              "div",
              { className: "panel plot-panel span-6" },
              React.createElement(Plot, {
                id: "dep-plot",
                className: "plot",
                data: depData,
                layout: {
                  ...plotTheme,
                  title: "Feature Dependence: Sales vs Macro Inputs",
                  xaxis: { title: "Feature Value" },
                  yaxis: { title: "Weekly Sales" },
                },
                config: { responsive: true, displaylogo: false },
              })
            ),

            React.createElement(
              "div",
              { className: "panel plot-panel span-6" },
              React.createElement(Plot, {
                id: "feature-series",
                className: "plot",
                data: fsData,
                layout: {
                  ...plotTheme,
                  title: `${feature} vs Sales Timeline`,
                  xaxis: { title: "Date" },
                  yaxis: { title: "Sales", side: "left" },
                  yaxis2: { title: feature, overlaying: "y", side: "right" },
                },
                config: { responsive: true, displaylogo: false },
              })
            )
          )
        );
      }

      createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
