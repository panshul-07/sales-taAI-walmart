<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Walmart Sales Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import React, { useMemo, useState } from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";
      import Papa from "https://esm.sh/papaparse@5.4.1";
      import {
        ResponsiveContainer,
        LineChart,
        Line,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ScatterChart,
        Scatter,
        BarChart,
        Bar,
        Cell,
      } from "https://esm.sh/recharts@2.12.7";
      import { Building2, Upload, Activity, Flame, DollarSign, TrendingUp } from "https://esm.sh/lucide-react@0.468.0";

      const FACTORS = [
        { id: "CPI", label: "CPI", color: "#2dd4bf" },
        { id: "Unemployment", label: "Unemployment", color: "#f59e0b" },
        { id: "Fuel_Price", label: "Fuel Price", color: "#60a5fa" },
        { id: "Temperature", label: "Temperature", color: "#fb7185" },
      ];

      function fmtCurrency(value) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        }).format(Number(value) || 0);
      }

      function fmtNum(value, digits = 2) {
        return Number(value || 0).toFixed(digits);
      }

      function pearsonCorr(x, y) {
        if (!x?.length || x.length !== y.length) return 0;
        const n = x.length;
        const meanX = x.reduce((a, b) => a + b, 0) / n;
        const meanY = y.reduce((a, b) => a + b, 0) / n;
        let numerator = 0;
        let dx = 0;
        let dy = 0;
        for (let i = 0; i < n; i += 1) {
          const vx = x[i] - meanX;
          const vy = y[i] - meanY;
          numerator += vx * vy;
          dx += vx * vx;
          dy += vy * vy;
        }
        const denominator = Math.sqrt(dx * dy);
        return denominator === 0 ? 0 : numerator / denominator;
      }

      function corrLabel(c) {
        const v = Math.abs(c);
        if (v > 0.7) return "Strong";
        if (v > 0.4) return "Moderate";
        if (v > 0.2) return "Weak";
        return "Very Weak";
      }

      function parseRows(rows) {
        return rows
          .map((r) => ({
            Store: Number(r.Store),
            Date: String(r.Date || ""),
            Weekly_Sales: Number(r.Weekly_Sales),
            Holiday_Flag: Number(r.Holiday_Flag || 0),
            Temperature: Number(r.Temperature),
            Fuel_Price: Number(r.Fuel_Price),
            CPI: Number(r.CPI),
            Unemployment: Number(r.Unemployment),
          }))
          .filter(
            (r) =>
              Number.isFinite(r.Store) &&
              r.Date &&
              Number.isFinite(r.Weekly_Sales) &&
              Number.isFinite(r.Temperature) &&
              Number.isFinite(r.Fuel_Price) &&
              Number.isFinite(r.CPI) &&
              Number.isFinite(r.Unemployment)
          )
          .sort((a, b) => new Date(a.Date) - new Date(b.Date));
      }

      function generateDemoData() {
        const out = [];
        const start = new Date("2010-02-05");
        const weeks = 156;
        for (let s = 1; s <= 45; s += 1) {
          for (let i = 0; i < weeks; i += 1) {
            const d = new Date(start);
            d.setDate(start.getDate() + i * 7);
            const season = Math.sin((i / 52) * 2 * Math.PI);
            const holiday = i % 26 === 0 || i % 26 === 25 ? 1 : 0;
            const base = 150000 + s * 1200 + season * 18000 + holiday * 22000;
            const fuel = 2.4 + ((i % 30) / 30) * 1.2;
            const cpi = 205 + i * 0.1 + (s % 5) * 0.25;
            const unemp = 9 - i * 0.01 + (s % 7) * 0.03;
            const temp = 58 + Math.sin((i / 52) * 2 * Math.PI + s * 0.08) * 22;
            const sales = Math.max(10000, base - fuel * 6000 - unemp * 1900 + cpi * 75 + Math.random() * 13000);
            out.push({
              Store: s,
              Date: d.toISOString().slice(0, 10),
              Weekly_Sales: Number(sales.toFixed(2)),
              Holiday_Flag: holiday,
              Temperature: Number(temp.toFixed(2)),
              Fuel_Price: Number(fuel.toFixed(3)),
              CPI: Number(cpi.toFixed(3)),
              Unemployment: Number(unemp.toFixed(3)),
            });
          }
        }
        return out;
      }

      function App() {
        const [allData, setAllData] = useState(generateDemoData());
        const [selectedStore, setSelectedStore] = useState("all");
        const [selectedFactor, setSelectedFactor] = useState("CPI");
        const [rowsLimit, setRowsLimit] = useState(160);
        const [message, setMessage] = useState("Loaded with demo data. Upload your walmart_sales.csv to replace.");

        const stores = useMemo(() => {
          const unique = [...new Set(allData.map((d) => d.Store))].sort((a, b) => a - b);
          return unique;
        }, [allData]);

        const storeData = useMemo(() => {
          const filtered = selectedStore === "all" ? allData : allData.filter((d) => d.Store === Number(selectedStore));
          return filtered.slice(-rowsLimit);
        }, [allData, selectedStore, rowsLimit]);

        const stats = useMemo(() => {
          if (!storeData.length) return { avg: 0, peak: 0, holidayAvg: 0, holidayCount: 0 };
          const sales = storeData.map((d) => d.Weekly_Sales);
          const holidayRows = storeData.filter((d) => d.Holiday_Flag === 1);
          return {
            avg: sales.reduce((a, b) => a + b, 0) / sales.length,
            peak: Math.max(...sales),
            holidayAvg: holidayRows.length
              ? holidayRows.reduce((acc, row) => acc + row.Weekly_Sales, 0) / holidayRows.length
              : 0,
            holidayCount: holidayRows.length,
          };
        }, [storeData]);

        const correlations = useMemo(() => {
          if (!storeData.length) return [];
          const y = storeData.map((d) => d.Weekly_Sales);
          return FACTORS.map((factor) => {
            const x = storeData.map((d) => d[factor.id]);
            const corr = pearsonCorr(x, y);
            return { ...factor, corr };
          });
        }, [storeData]);

        const scatterData = useMemo(
          () =>
            storeData.map((d) => ({
              x: d[selectedFactor],
              y: d.Weekly_Sales,
              holiday: d.Holiday_Flag,
              date: d.Date,
            })),
          [storeData, selectedFactor]
        );

        const trendRows = useMemo(
          () =>
            storeData.map((d) => ({
              Date: d.Date,
              Weekly_Sales: d.Weekly_Sales,
            })),
          [storeData]
        );

        const handleFileUpload = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (result) => {
              const parsed = parseRows(result.data || []);
              if (!parsed.length) {
                setMessage("CSV parsed but no valid rows found. Ensure required columns exist.");
                return;
              }
              setAllData(parsed);
              setSelectedStore("all");
              setMessage(`Loaded ${parsed.length} rows from ${file.name}.`);
            },
            error: () => {
              setMessage("Failed to parse CSV. Please upload a valid walmart sales CSV file.");
            },
          });
        };

        const selectedColor = FACTORS.find((f) => f.id === selectedFactor)?.color || "#2dd4bf";

        return (
          React.createElement("div", {
            className: "min-h-screen text-slate-100",
            style: {
              background:
                "radial-gradient(1000px 500px at 5% -10%, rgba(45,212,191,0.2), transparent 60%), radial-gradient(1200px 650px at 100% 110%, rgba(245,158,11,0.2), transparent 65%), linear-gradient(135deg, #05242f 0%, #0d1222 58%, #111827 100%)",
            },
          },
            React.createElement("div", { className: "max-w-[1500px] mx-auto p-4 md:p-6 lg:p-8" },
              React.createElement("header", { className: "flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-5" },
                React.createElement("div", null,
                  React.createElement("h1", { className: "text-2xl md:text-4xl font-bold tracking-tight" }, "Walmart Sales Analytics Dashboard"),
                  React.createElement("p", { className: "text-slate-300 mt-2 text-sm md:text-base" }, "Responsive React dashboard with CSV upload, store-level analytics, and factor correlations")
                ),
                React.createElement("div", { className: "text-xs md:text-sm px-3 py-2 rounded-xl border border-cyan-400/30 bg-cyan-500/10" }, `Stores available: ${stores.length || 0}`)
              ),

              React.createElement("section", { className: "grid grid-cols-1 xl:grid-cols-12 gap-4" },
                React.createElement("div", { className: "xl:col-span-8 rounded-2xl border border-white/15 bg-white/5 backdrop-blur-sm p-4" },
                  React.createElement("div", { className: "flex items-center gap-2 mb-3 text-cyan-300" }, React.createElement(Upload, { size: 16 }), "Upload CSV"),
                  React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                    React.createElement("label", { className: "text-sm" },
                      React.createElement("span", { className: "text-slate-300" }, "Select walmart_sales.csv"),
                      React.createElement("input", {
                        type: "file",
                        accept: ".csv,text/csv",
                        className: "w-full mt-1 block text-sm file:mr-3 file:rounded-md file:border-0 file:bg-cyan-500 file:px-3 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-cyan-400",
                        onChange: handleFileUpload,
                      })
                    ),
                    React.createElement("div", { className: "text-xs md:text-sm rounded-lg border border-white/15 bg-slate-900/30 p-3 text-slate-200" },
                      "Required columns: Store, Date, Weekly_Sales, Holiday_Flag, Temperature, Fuel_Price, CPI, Unemployment"
                    )
                  ),
                  React.createElement("p", { className: "text-xs md:text-sm text-slate-300 mt-2" }, message)
                ),

                React.createElement("div", { className: "xl:col-span-4 rounded-2xl border border-white/15 bg-white/5 backdrop-blur-sm p-4" },
                  React.createElement("div", { className: "flex items-center gap-2 mb-3 text-amber-300" }, React.createElement(Building2, { size: 16 }), "Store Selector"),
                  React.createElement("div", { className: "grid grid-cols-3 sm:grid-cols-5 gap-2 max-h-44 overflow-auto pr-1" },
                    React.createElement(
                      "button",
                      {
                        className: `text-xs rounded-md px-2 py-1 border transition ${selectedStore === "all" ? "bg-cyan-500 text-white border-cyan-300" : "bg-slate-900/30 border-white/20 hover:bg-slate-800/50"}`,
                        onClick: () => setSelectedStore("all"),
                      },
                      "All"
                    ),
                    ...stores.map((s) =>
                      React.createElement(
                        "button",
                        {
                          key: s,
                          className: `text-xs rounded-md px-2 py-1 border transition ${String(s) === String(selectedStore) ? "bg-cyan-500 text-white border-cyan-300" : "bg-slate-900/30 border-white/20 hover:bg-slate-800/50"}`,
                          onClick: () => setSelectedStore(String(s)),
                        },
                        `S${s}`
                      )
                    )
                  ),
                  React.createElement("label", { className: "block mt-4 text-sm text-slate-300" }, "Recent Weeks"),
                  React.createElement("input", {
                    type: "range",
                    min: 52,
                    max: 260,
                    value: rowsLimit,
                    onChange: (e) => setRowsLimit(Number(e.target.value)),
                    className: "w-full mt-1",
                  }),
                  React.createElement("div", { className: "text-xs text-slate-300 mt-1" }, `${rowsLimit} weeks`)
                )
              ),

              React.createElement("section", { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-4" },
                [
                  { label: "Avg Weekly Sales", value: fmtCurrency(stats.avg), icon: DollarSign, tint: "from-cyan-500/25 to-cyan-900/20" },
                  { label: "Peak Sales", value: fmtCurrency(stats.peak), icon: TrendingUp, tint: "from-amber-500/30 to-amber-900/20" },
                  { label: "Holiday Avg", value: fmtCurrency(stats.holidayAvg), icon: Flame, tint: "from-rose-500/25 to-rose-900/20" },
                  { label: "Holiday Count", value: String(stats.holidayCount), icon: Activity, tint: "from-indigo-500/25 to-indigo-900/20" },
                ].map((card) =>
                  React.createElement("div", { key: card.label, className: `rounded-2xl border border-white/15 p-4 bg-gradient-to-br ${card.tint}` },
                    React.createElement("div", { className: "flex items-center justify-between" },
                      React.createElement("span", { className: "text-sm text-slate-200" }, card.label),
                      React.createElement(card.icon, { size: 16 })
                    ),
                    React.createElement("div", { className: "text-2xl font-semibold mt-2" }, card.value)
                  )
                )
              ),

              React.createElement("section", { className: "grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4" },
                React.createElement("div", { className: "xl:col-span-8 rounded-2xl border border-white/15 bg-white/5 p-4" },
                  React.createElement("h2", { className: "text-lg font-semibold mb-3" }, "Weekly Sales Trend"),
                  React.createElement("div", { className: "h-[320px] md:h-[360px]" },
                    React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                      React.createElement(LineChart, { data: trendRows },
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.2)" }),
                        React.createElement(XAxis, { dataKey: "Date", tick: { fill: "#e2e8f0", fontSize: 11 } }),
                        React.createElement(YAxis, { tick: { fill: "#e2e8f0", fontSize: 11 } }),
                        React.createElement(Tooltip, {
                          formatter: (v) => fmtCurrency(v),
                          contentStyle: { background: "#0f172a", border: "1px solid rgba(148,163,184,0.4)" },
                        }),
                        React.createElement(Line, { type: "monotone", dataKey: "Weekly_Sales", stroke: "#2dd4bf", dot: false, strokeWidth: 2.4 })
                      )
                    )
                  )
                ),

                React.createElement("div", { className: "xl:col-span-4 rounded-2xl border border-white/15 bg-white/5 p-4" },
                  React.createElement("h2", { className: "text-lg font-semibold mb-3" }, "Factor Correlations"),
                  React.createElement("div", { className: "space-y-3" },
                    ...correlations.map((c) =>
                      React.createElement("div", { key: c.id, className: "rounded-xl border border-white/15 bg-slate-900/30 p-3" },
                        React.createElement("div", { className: "flex items-center justify-between text-sm" },
                          React.createElement("span", null, c.label),
                          React.createElement("span", { className: "font-semibold" }, `${fmtNum(c.corr, 3)} (${corrLabel(c.corr)})`)
                        ),
                        React.createElement("div", { className: "h-2 rounded-full bg-black/30 mt-2 overflow-hidden" },
                          React.createElement("div", {
                            className: "h-full",
                            style: {
                              width: `${Math.min(100, Math.abs(c.corr) * 100)}%`,
                              backgroundColor: c.corr >= 0 ? "#2dd4bf" : "#f59e0b",
                            },
                          })
                        )
                      )
                    )
                  )
                )
              ),

              React.createElement("section", { className: "grid grid-cols-1 xl:grid-cols-12 gap-4 mt-4 pb-6" },
                React.createElement("div", { className: "xl:col-span-7 rounded-2xl border border-white/15 bg-white/5 p-4" },
                  React.createElement("div", { className: "flex items-center justify-between gap-3 mb-3" },
                    React.createElement("h2", { className: "text-lg font-semibold" }, "Scatter Analysis"),
                    React.createElement("select", {
                      value: selectedFactor,
                      onChange: (e) => setSelectedFactor(e.target.value),
                      className: "bg-slate-900/50 border border-white/20 rounded-md px-3 py-1 text-sm",
                    }, ...FACTORS.map((f) => React.createElement("option", { key: f.id, value: f.id }, f.label)))
                  ),
                  React.createElement("div", { className: "h-[320px] md:h-[360px]" },
                    React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                      React.createElement(ScatterChart, null,
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.2)" }),
                        React.createElement(XAxis, { type: "number", dataKey: "x", name: selectedFactor, tick: { fill: "#e2e8f0", fontSize: 11 } }),
                        React.createElement(YAxis, { type: "number", dataKey: "y", name: "Weekly Sales", tick: { fill: "#e2e8f0", fontSize: 11 } }),
                        React.createElement(Tooltip, {
                          cursor: { strokeDasharray: "3 3" },
                          formatter: (v, n) => (n === "y" ? fmtCurrency(v) : fmtNum(v, 2)),
                          labelFormatter: (_, payload) => payload?.[0]?.payload?.date || "",
                          contentStyle: { background: "#0f172a", border: "1px solid rgba(148,163,184,0.4)" },
                        }),
                        React.createElement(Scatter, { data: scatterData, fill: selectedColor },
                          ...scatterData.map((p, idx) =>
                            React.createElement(Cell, {
                              key: idx,
                              fill: p.holiday ? "#f59e0b" : selectedColor,
                            })
                          )
                        )
                      )
                    )
                  )
                ),

                React.createElement("div", { className: "xl:col-span-5 rounded-2xl border border-white/15 bg-white/5 p-4" },
                  React.createElement("h2", { className: "text-lg font-semibold mb-3" }, "Multi-Factor Correlation Bar Chart"),
                  React.createElement("div", { className: "h-[320px] md:h-[360px]" },
                    React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                      React.createElement(BarChart, { data: correlations },
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.2)" }),
                        React.createElement(XAxis, { dataKey: "label", tick: { fill: "#e2e8f0", fontSize: 11 } }),
                        React.createElement(YAxis, {
                          domain: [-1, 1],
                          tick: { fill: "#e2e8f0", fontSize: 11 },
                        }),
                        React.createElement(Tooltip, {
                          formatter: (v) => [fmtNum(v, 3), "Correlation"],
                          contentStyle: { background: "#0f172a", border: "1px solid rgba(148,163,184,0.4)" },
                        }),
                        React.createElement(Bar, { dataKey: "corr", radius: [8, 8, 0, 0] },
                          ...correlations.map((c) =>
                            React.createElement(Cell, {
                              key: c.id,
                              fill: c.corr >= 0 ? "#2dd4bf" : "#f59e0b",
                            })
                          )
                        )
                      )
                    )
                  )
                )
              )
            )
          )
        );
      }

      createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
