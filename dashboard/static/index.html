<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Walmart Forecast Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              ta: {
                bg: "#06161c",
                panel: "#0b2431",
                panel2: "#0a1d2a",
                border: "#20485d",
                text: "#e8f3f6",
                muted: "#9eb7bf",
                actual: "#1fd0c6",
                pred: "#6ea8ff",
                sim: "#f2cc72",
                warn: "#e3ae4f",
              },
            },
            boxShadow: {
              panel: "0 10px 26px rgba(0,0,0,.32)",
            },
          },
        },
      };
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  </head>
  <body class="bg-slate-100 text-slate-900 dark bg-ta-bg dark:text-ta-text">
    <div id="root"></div>

    <script type="text/babel">
      const {
        LineChart,
        Line,
        ScatterChart,
        Scatter,
        XAxis,
        YAxis,
        Tooltip,
        CartesianGrid,
        ResponsiveContainer,
        Legend,
      } = window.Recharts;

      const FEATURES = ["CPI", "Unemployment", "Fuel_Price", "Temperature"];
      const fmtMoney = (n) =>
        new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 }).format(
          Number(n || 0),
        );
      const fmtCompact = (n) => {
        const v = Number(n || 0);
        if (Math.abs(v) >= 1_000_000) return `${(v / 1_000_000).toFixed(1)}M`;
        if (Math.abs(v) >= 1_000) return `${(v / 1_000).toFixed(1)}K`;
        return v.toFixed(0);
      };
      const api = (path, opts) =>
        fetch(path, opts).then((r) => {
          if (!r.ok) throw new Error(`${path} failed`);
          return r.json();
        });

      function App() {
        const [theme, setTheme] = React.useState(localStorage.getItem("theme") || "dark");
        const [stores, setStores] = React.useState([]);
        const [store, setStore] = React.useState("all");
        const [weeks, setWeeks] = React.useState(160);
        const [factor, setFactor] = React.useState("CPI");
        const [status, setStatus] = React.useState("Loading...");
        const [overview, setOverview] = React.useState(null);
        const [rows, setRows] = React.useState([]);
        const [corr, setCorr] = React.useState([]);
        const [coef, setCoef] = React.useState([]);
        const [adjustments, setAdjustments] = React.useState({ CPI: 0, Unemployment: 0, Fuel_Price: 0, Temperature: 0 });

        const [chatOpen, setChatOpen] = React.useState(false);
        const [chatText, setChatText] = React.useState("");
        const [chatSession, setChatSession] = React.useState(localStorage.getItem("taai_session") || "");
        const [chatMessages, setChatMessages] = React.useState([
          { role: "assistant", content: "taAI ready. Ask in English or Hinglish." },
        ]);

        React.useEffect(() => {
          document.documentElement.classList.toggle("dark", theme === "dark");
          localStorage.setItem("theme", theme);
        }, [theme]);

        const adjustedRows = React.useMemo(() => {
          const beta = Object.fromEntries(coef.map((c) => [c.feature, Number(c.beta_per_unit || 0)]));
          return rows.map((r) => {
            let deltaSales = 0;
            const xAdj = {};
            for (const f of FEATURES) {
              const base = Number(r[f]);
              const pct = Number(adjustments[f] || 0) / 100;
              const newVal = base * (1 + pct);
              xAdj[f] = newVal;
              deltaSales += (newVal - base) * (beta[f] || 0);
            }
            return {
              ...r,
              Adjusted_Factor: xAdj[factor],
              Simulated_Sales: Math.max(1000, Number(r.Predicted_Sales) + deltaSales),
            };
          });
        }, [rows, coef, adjustments, factor]);

        const trendData = React.useMemo(
          () =>
            rows.map((r, i) => ({
              Date: r.Date,
              Actual: Number(r.Weekly_Sales),
              Baseline: Number(r.Predicted_Sales),
              Simulated: Number(adjustedRows[i]?.Simulated_Sales || r.Predicted_Sales),
            })),
          [rows, adjustedRows],
        );

        const scatterData = React.useMemo(
          () =>
            adjustedRows.map((r) => ({
              x: Number(r.Adjusted_Factor),
              y: Number(r.Simulated_Sales),
              holiday: Number(r.Holiday_Flag) === 1,
            })),
          [adjustedRows],
        );

        const impactSummary = React.useMemo(() => {
          if (!rows.length) return "";
          const simAvg = adjustedRows.reduce((a, b) => a + Number(b.Simulated_Sales), 0) / adjustedRows.length;
          const baseAvg = rows.reduce((a, b) => a + Number(b.Predicted_Sales), 0) / rows.length;
          const diff = simAvg - baseAvg;
          const pct = (diff / Math.max(baseAvg, 1)) * 100;
          return `Simulated avg change vs baseline: ${fmtMoney(diff)} (${pct.toFixed(2)}%)`;
        }, [rows, adjustedRows]);

        const load = React.useCallback(async () => {
          setStatus("Loading...");
          const q = `store=${encodeURIComponent(store)}&weeks=${weeks}`;
          const [st, ov, sr, cr, cf] = await Promise.all([
            api("/api/stores"),
            api(`/api/overview?${q}`),
            api(`/api/store-data?${q}`),
            api(`/api/correlations?${q}`),
            api(`/api/coefficients?${q}`),
          ]);
          setStores(st);
          setOverview(ov);
          setRows(sr);
          setCorr(cr);
          setCoef(cf.rows || []);
          setStatus(`Showing ${ov.records} rows (${ov.date_min} to ${ov.date_max}) | ${cf.model_source}`);
        }, [store, weeks]);

        React.useEffect(() => {
          load().catch((e) => setStatus(`Failed: ${e.message}`));
        }, [load]);

        const sendChat = async () => {
          if (!chatText.trim()) return;
          const msg = chatText.trim();
          setChatText("");
          setChatMessages((m) => [...m, { role: "user", content: msg }]);
          try {
            const res = await api("/api/taai/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: msg, session_id: chatSession || null }),
            });
            if (!chatSession) {
              setChatSession(res.session_id);
              localStorage.setItem("taai_session", res.session_id);
            }
            setChatMessages((m) => [...m, { role: "assistant", content: res.answer }]);
          } catch (e) {
            setChatMessages((m) => [...m, { role: "assistant", content: `Error: ${e.message}` }]);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-b from-ta-bg via-[#07222f] to-[#061821] text-ta-text dark:text-ta-text text-slate-900">
            <div className="mx-auto max-w-[1540px] px-4 py-4">
              <div className="grid gap-3 md:grid-cols-[1fr_auto] items-end">
                <div>
                  <h1 className="text-5xl font-bold tracking-tight bg-gradient-to-r from-[#d8e8ea] via-[#1fd0c6] to-[#f2cc72] bg-clip-text text-transparent">
                    Walmart Forecast Dashboard
                  </h1>
                  <p className="text-sm text-ta-muted">Model-backed analysis and simulations</p>
                </div>
                <div className="rounded-xl border border-ta-border bg-[#0b2431]/90 px-3 py-2 shadow-panel flex items-center gap-2">
                  <button
                    className={`px-3 py-1 rounded-lg border ${theme === "dark" ? "bg-[#103646] border-[#1fd0c6]" : "bg-white text-slate-900 border-slate-300"}`}
                    onClick={() => setTheme("dark")}
                  >
                    Dark
                  </button>
                  <button
                    className={`px-3 py-1 rounded-lg border ${theme === "light" ? "bg-white text-slate-900 border-slate-300" : "border-[#335f70]"}`}
                    onClick={() => setTheme("light")}
                  >
                    Light
                  </button>
                </div>
              </div>

              <div className="mt-4 grid gap-4 lg:grid-cols-12">
                <div className="lg:col-span-8 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4 shadow-panel">
                  <div className="grid gap-3 md:grid-cols-2">
                    <div>
                      <label className="text-sm text-ta-muted">Store</label>
                      <select className="w-full mt-1 rounded-lg bg-[#0c2a37] border border-ta-border px-3 py-2" value={store} onChange={(e) => setStore(e.target.value)}>
                        <option value="all">All Stores</option>
                        {stores.map((s) => (
                          <option key={s.Store} value={String(s.Store)}>{`Store ${s.Store}`}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="text-sm text-ta-muted">Weeks: {weeks}</label>
                      <input className="w-full mt-2" type="range" min="52" max="260" value={weeks} onChange={(e) => setWeeks(Number(e.target.value))} />
                    </div>
                  </div>
                </div>

                <div className="lg:col-span-4 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4 shadow-panel">
                  <label className="text-sm text-ta-muted">Scatter Factor</label>
                  <select className="w-full mt-1 rounded-lg bg-[#0c2a37] border border-ta-border px-3 py-2" value={factor} onChange={(e) => setFactor(e.target.value)}>
                    {FEATURES.map((f) => (
                      <option key={f} value={f}>{f}</option>
                    ))}
                  </select>
                  <div className="text-sm text-ta-muted mt-2">{status}</div>
                </div>
              </div>

              <div className="mt-4 grid gap-3 md:grid-cols-5">
                {[
                  ["Average Weekly Sales", overview?.avg_weekly_sales || 0],
                  ["Peak Sales", overview?.peak_sales || 0],
                  ["Holiday Avg", overview?.holiday_avg || 0],
                  ["Holiday Count", overview?.holiday_count || 0, true],
                  ["Simulated Avg Sales", adjustedRows.length ? adjustedRows.reduce((a, b) => a + Number(b.Simulated_Sales), 0) / adjustedRows.length : 0],
                ].map(([k, v, raw]) => (
                  <div key={k} className="rounded-xl border border-ta-border bg-gradient-to-b from-[#0c3140] to-[#0b2735] p-3">
                    <div className="text-xs text-ta-muted">{k}</div>
                    <div className="text-5xl font-bold leading-tight">{raw ? String(v) : fmtMoney(v)}</div>
                  </div>
                ))}
              </div>

              <div className="mt-4 grid gap-4 lg:grid-cols-12">
                <div className="lg:col-span-8 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4">
                  <div className="mb-2 text-3xl font-semibold">Weekly Sales vs Baseline vs Simulated</div>
                  <div className="h-[340px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={trendData}>
                        <CartesianGrid stroke="rgba(255,255,255,.09)" />
                        <XAxis dataKey="Date" tick={{ fill: "#9eb7bf", fontSize: 11 }} />
                        <YAxis tickFormatter={fmtCompact} tick={{ fill: "#9eb7bf", fontSize: 11 }} />
                        <Tooltip formatter={(v) => fmtMoney(v)} />
                        <Legend />
                        <Line type="monotone" dataKey="Actual" stroke="#1fd0c6" dot={false} strokeWidth={2} />
                        <Line type="monotone" dataKey="Baseline" stroke="#6ea8ff" dot={false} strokeWidth={2} />
                        <Line type="monotone" dataKey="Simulated" stroke="#f2cc72" dot={false} strokeDasharray="6 4" strokeWidth={2} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                <div className="lg:col-span-4 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4">
                  <div className="mb-3 text-3xl font-semibold">What-If Controls (% Change)</div>
                  <div className="grid grid-cols-2 gap-3">
                    {FEATURES.map((f) => (
                      <div key={f}>
                        <label className="text-sm text-ta-muted">{f}: {adjustments[f]}%</label>
                        <input
                          className="w-full"
                          type="range"
                          min="-30"
                          max="30"
                          value={adjustments[f]}
                          onChange={(e) => setAdjustments((a) => ({ ...a, [f]: Number(e.target.value) }))}
                        />
                      </div>
                    ))}
                  </div>
                  <div className="mt-3 text-sm text-ta-muted">{impactSummary}</div>
                </div>
              </div>

              <div className="mt-4 grid gap-4 lg:grid-cols-12 pb-20">
                <div className="lg:col-span-8 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4">
                  <div className="mb-2 text-3xl font-semibold">Scatter: Adjusted Factor vs Simulated Sales</div>
                  <div className="h-[340px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <ScatterChart>
                        <CartesianGrid stroke="rgba(255,255,255,.09)" />
                        <XAxis type="number" dataKey="x" name={factor} tick={{ fill: "#9eb7bf", fontSize: 11 }} />
                        <YAxis type="number" dataKey="y" name="Simulated Sales" tickFormatter={fmtCompact} tick={{ fill: "#9eb7bf", fontSize: 11 }} />
                        <Tooltip cursor={{ strokeDasharray: "3 3" }} formatter={(v, n) => (n === "y" ? fmtMoney(v) : Number(v).toFixed(3))} />
                        <Scatter data={scatterData.filter((d) => !d.holiday)} fill="#1fd0c6" />
                        <Scatter data={scatterData.filter((d) => d.holiday)} fill="#e3ae4f" />
                      </ScatterChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                <div className="lg:col-span-4 rounded-2xl border border-ta-border bg-gradient-to-b from-[#0b2431] to-[#0a1d2a] p-4">
                  <div className="mb-2 text-3xl font-semibold">Correlations + Coefficients</div>
                  <div className="space-y-2">
                    {corr.map((c) => {
                      const pct = Math.min(100, Math.abs(Number(c.corr)) * 100);
                      return (
                        <div key={c.feature} className="rounded-lg border border-ta-border p-2">
                          <div className="flex justify-between text-base">
                            <span>{c.feature}</span>
                            <span>{Number(c.corr).toFixed(3)}</span>
                          </div>
                          <div className="mt-1 h-2 rounded-full bg-[#23384a] overflow-hidden">
                            <div className="h-full" style={{ width: `${pct}%`, background: Number(c.corr) >= 0 ? "#1fd0c6" : "#e3ae4f" }} />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  <table className="w-full mt-3 text-sm">
                    <thead>
                      <tr className="text-ta-muted border-b border-ta-border">
                        <th className="text-left py-1">Feature</th>
                        <th className="text-right py-1">Corr</th>
                        <th className="text-right py-1">Log beta</th>
                        <th className="text-right py-1">Impact +10%</th>
                      </tr>
                    </thead>
                    <tbody>
                      {coef.map((c) => (
                        <tr key={c.feature} className="border-b border-[#1a3646]">
                          <td className="py-1">{c.feature}</td>
                          <td className="text-right">{Number(c.corr).toFixed(3)}</td>
                          <td className="text-right">{Number(c.beta_log || 0).toFixed(3)}</td>
                          <td className="text-right">{Number(c.pct_impact_10pct || 0).toFixed(2)}%</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <button
              className="fixed bottom-4 right-4 rounded-full bg-[#1fd0c6] text-[#032028] px-4 py-3 font-semibold shadow-2xl"
              onClick={() => setChatOpen((v) => !v)}
            >
              taAI
            </button>

            {chatOpen && (
              <div className="fixed bottom-20 right-4 w-[360px] max-w-[92vw] rounded-2xl border border-ta-border bg-[#091d28] shadow-2xl overflow-hidden">
                <div className="px-3 py-2 border-b border-ta-border font-semibold">taAI Economist Assistant</div>
                <div className="h-[320px] overflow-y-auto p-3 space-y-2">
                  {chatMessages.map((m, idx) => (
                    <div key={idx} className={`rounded-lg px-3 py-2 text-sm ${m.role === "user" ? "bg-[#173646] ml-8" : "bg-[#102734] mr-8"}`}>
                      {m.content}
                    </div>
                  ))}
                </div>
                <div className="p-2 border-t border-ta-border flex gap-2">
                  <input
                    className="flex-1 rounded-lg bg-[#0f2a38] border border-ta-border px-3 py-2 text-sm"
                    value={chatText}
                    onChange={(e) => setChatText(e.target.value)}
                    placeholder="Ask taAI..."
                    onKeyDown={(e) => e.key === "Enter" && sendChat()}
                  />
                  <button className="rounded-lg bg-[#1fd0c6] px-3 text-[#032028] font-semibold" onClick={sendChat}>Send</button>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
